<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>韩小平的博客 | Firekylin博客优化指南</title>
    <meta name="description" content="Just A Coder.">
    
    
    <link rel="preload" href="/blog/assets/css/23.styles.cc8c2f9e.css" as="style"><link rel="preload" href="/blog/assets/js/app.1f817541.js" as="script"><link rel="preload" href="/blog/assets/js/4.deae28fa.js" as="script"><link rel="prefetch" href="/blog/assets/js/12.814f811a.js"><link rel="prefetch" href="/blog/assets/js/1.411138db.js"><link rel="prefetch" href="/blog/assets/js/2.6d9529a4.js"><link rel="prefetch" href="/blog/assets/js/3.4fdc0d88.js"><link rel="prefetch" href="/blog/assets/js/5.9fdd6adc.js"><link rel="prefetch" href="/blog/assets/js/6.00a6ab47.js"><link rel="prefetch" href="/blog/assets/js/7.da4f18c9.js"><link rel="prefetch" href="/blog/assets/js/8.913fdfc3.js"><link rel="prefetch" href="/blog/assets/js/9.edf39113.js"><link rel="prefetch" href="/blog/assets/js/10.2f0c9cf4.js"><link rel="prefetch" href="/blog/assets/js/11.615d4175.js"><link rel="prefetch" href="/blog/assets/js/0.cffbc176.js"><link rel="prefetch" href="/blog/assets/js/13.69b37d45.js"><link rel="prefetch" href="/blog/assets/js/14.a0bb1f94.js"><link rel="prefetch" href="/blog/assets/js/15.9690300e.js"><link rel="prefetch" href="/blog/assets/js/16.d94b26bb.js"><link rel="prefetch" href="/blog/assets/js/17.49b0032e.js"><link rel="prefetch" href="/blog/assets/js/18.53f1b6f9.js"><link rel="prefetch" href="/blog/assets/js/19.49c9af97.js"><link rel="prefetch" href="/blog/assets/js/20.d43d8101.js"><link rel="prefetch" href="/blog/assets/js/21.c6d918ad.js"><link rel="prefetch" href="/blog/assets/js/22.3be36221.js">
    <link rel="stylesheet" href="/blog/assets/css/23.styles.cc8c2f9e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/blog/" class="home-link router-link-active"><!----><span class="site-name">
      韩小平的博客
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/posts/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/blog/links/" class="nav-link">友链</a></div><a href="https://github.com/excaliburhan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/posts/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/blog/links/" class="nav-link">友链</a></div><a href="https://github.com/excaliburhan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><!----></div><div class="page"><div class="content"><h1 id="firekylin博客优化指南"><a href="#firekylin博客优化指南" aria-hidden="true" class="header-anchor">#</a> Firekylin博客优化指南</h1><h2 id="firekylin博客"><a href="#firekylin博客" aria-hidden="true" class="header-anchor">#</a> Firekylin博客</h2><p>Firekylin博客是一个基于ThinkJS的博客系统，本身对博客的优化已经非常不错，很多资源都已经进行了压缩或者缓存策略。</p><p>但是本着能缓存就要缓存的策略，Firekylin还是有一点优化空间的，下面就是优化的要点。</p><h2 id="优化步骤"><a href="#优化步骤" aria-hidden="true" class="header-anchor">#</a> 优化步骤</h2><p>首先打开网站首页<a href="https://excaliburhan.com" target="_blank" rel="noopener noreferrer">https://excaliburhan.com</a>。右键<code>检查(或者审查元素)</code>，选择<code>Network</code>查看资源加载情况：</p><p><img src="https://static.excaliburhan.com/blog/20161226/Qr3U3tIre1tW5yiitXRf-coX.jpeg?imageView2/0/w/600" alt="alt"></p><p>可以看到，加载的资源主要有几种，<code>首页logo</code>，<code>iconfont字体</code>，<code>google统计代码</code>，因为我没有设置首页背景图，如果有，处理应该是和logo一致的，这里就不展开了。</p><p>我们首先从<code>首页logo</code>开始。</p><h3 id="处理logo"><a href="#处理logo" aria-hidden="true" class="header-anchor">#</a> 处理logo</h3><p>我采用的logo已经是压缩过的图片，但是还有10k左右的大小，我们的目标是图片加载一律走缓存。</p><p>首先采用了使用base64编码的方式，这样图片是会被缓存的。来看一下效果：</p><p><img src="https://static.excaliburhan.com/blog/20161226/TQ8ArbcBsxN2kl501WgI4DVq.jpeg?imageView2/0/w/600" alt="alt"></p><p>嗯，很好，图片被缓存了。不过，等等！<code>index.html</code>从原来的6.8kb变成了17.4kb，反而加载的资源大小更大了！究其原因，就是图片从jpg转变成base64图片，大小变成12kb左右，而首页logo采用的是img标签，等于说12kb的文本加载到了<code>index.html</code>中，这显然不是我们需要的。</p><p>如果改成background的形式，理论上可以解决，但是加载的大小转移到了css样式文件中，1是没有解决根本问题(base64本身带来的字节大小)，2是需要改写博客源代码，成本太高，换另外一种方案。</p><p>由于之前给Firekylin提了mr，现在图片上传可以支持cdn，而我一直采用的是七牛的cdn，现在换成七牛cdn看看。</p><p><img src="https://static.excaliburhan.com/blog/20161226/6f4ngZN4E5q6eMmH5P849w0q.jpeg?imageView2/0/w/600" alt="alt"></p><p>可以看到图片已经被缓存了，这里图片走的是cdn的缓存机制，所以它的有效时间是由cdn设置决定的。如果你看的比较仔细，你可以发现<code>index.html</code>的大小也变小了，那是因为我之前忘记截图了，更新新版本的Firekylin导致的，看来Firekylin也一直在优化呢(笑)。而这里，我们就把它还当作是6.8kb吧。</p><h3 id="iconfont"><a href="#iconfont" aria-hidden="true" class="header-anchor">#</a> iconfont</h3><p>Firekylin采用了iconfont来处理一些全局用到的图标，首页的菜单会用到这个文件。</p><p>由于这个文件以后可能会有变化，所以Firekylin给它添加了<code>?v=</code>的版本信息。</p><p>那这个文件我们要怎么缓存呢，结论是采用nginx缓存！其实类似图片如果没有cdn的服务，也是可以采用这个方案的，配置大概如下：</p><p>首先在<code>http</code>里配置缓存信息</p><pre class="language-nginx"><code><span class="token keyword">proxy_cache_path</span>   <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword">proxy_cache</span> levels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">2</span> keys_zone<span class="token operator">=</span>pnc<span class="token punctuation">:</span><span class="token number">300</span>m inactive<span class="token operator">=</span><span class="token number">10</span>m max_size<span class="token operator">=</span><span class="token number">5</span>g<span class="token punctuation">;</span>
<span class="token keyword">proxy_temp_path</span>    <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>proxy_temp<span class="token punctuation">;</span>
<span class="token keyword">proxy_cache_key</span>    <span class="token variable">$host</span><span class="token variable">$uri</span><span class="token variable">$is_args</span><span class="token variable">$args</span><span class="token punctuation">;</span>
</code></pre><p>然后在<code>server</code>中配置相关的内容，这里我把图片的也贴出来，但是本站实际走的是cdn配置，nginx并不会生效，如果你有需要，可以按照这个进行配置</p><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">proxy_cache</span>               pnc<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_valid</span>         <span class="token number">200</span> <span class="token number">304</span> <span class="token number">1</span>d<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_valid</span>         any <span class="token number">1</span>m<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_lock</span>          on<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_lock_timeout</span>  <span class="token number">5</span>s<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_use_stale</span>     updating error <span class="token keyword">timeout</span>   invalid_header http_500 http_502<span class="token punctuation">;</span>
        etag                      on<span class="token punctuation">;</span>
        <span class="token keyword">expires</span>                   <span class="token number">1</span>d<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>ico<span class="token operator">|</span>svg<span class="token operator">|</span>ttf<span class="token operator">|</span>eot<span class="token operator">|</span>woff<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">proxy_cache</span>               pnc<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_valid</span>         <span class="token number">200</span> <span class="token number">304</span> <span class="token number">1</span>y<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_valid</span>         any <span class="token number">1</span>m<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_lock</span>          on<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_lock_timeout</span>  <span class="token number">5</span>s<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_use_stale</span>     updating error <span class="token keyword">timeout</span> invalid_header http_500 http_502<span class="token punctuation">;</span>
        etag                      on<span class="token punctuation">;</span>
        <span class="token keyword">expires</span>                   <span class="token number">1</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>这里需要注意的是，<code>server</code>中的<code>proxy_cache</code>的名称要和<code>http</code>中配置的<code>keys_zone</code>一致。</p><p>上面的<code>server</code>配置，第一条是对常见图片结尾的文件进行一天的缓存，这里不建议把缓存时间定很长，否则你的同路径同名称的图片可能很久都不会改变。第二条就是对字体文件结尾的文件进行一年的缓存。这个可以设置久一些，因为一般这个文件是不会变动的，如果变动，版本信息导致的变动也会让etag改变，从而刷新缓存。</p><p>重启nginx看下效果：</p><p><img src="https://static.excaliburhan.com/blog/20161226/vTIfBpqGqt4PEevZNoeVXjKq.jpeg?imageView2/0/w/600" alt="alt"></p><h3 id="google统计代码"><a href="#google统计代码" aria-hidden="true" class="header-anchor">#</a> google统计代码</h3><p>下面就是google的统计代码了。由于是异步获取的google官方的analytics.js文件，其实对于网站加载是完全没有影响的。而google设置的缓存时间是2小时，这个时间太短了，以至于google自己的官方检测给出的意见是提高该js的缓存时间- -，检测的地址是:</p><p><a href="https://developers.google.com/speed/pagespeed/insights/" target="_blank" rel="noopener noreferrer">https://developers.google.com/speed/pagespeed/insights/</a></p><p>那么对于这个js文件怎么办呢？分析一下，主要有两点，一是延长js的缓存时间，而是保证js是最新的。</p><p>google官方是提供自定义请求来达到统计功能的，<a href="https://imququ.com/post/summary-of-my-blog-optimization.html" target="_blank" rel="noopener noreferrer">屈屈的零散优化点汇总</a>这篇文章就是采用这个方法的。</p><p>但是这个方法有一定的局限性，一是需要改写服务端的代码，添加统计逻辑，二是你的服务器必须能ping通google的api地址，所以说并不太实用。</p><p>我这里采用了<code>nginx缓存</code>+<code>定时任务</code>将google统计代码本地化，从而达到优化的目的。</p><p>首先，当然是nginx缓存配置：</p><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token punctuation">(</span>analytics\<span class="token punctuation">.</span>js<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
        <span class="token keyword">alias</span>                     <span class="token operator">/</span>path<span class="token operator">-</span>to<span class="token operator">-</span>static<span class="token operator">/</span>analytics<span class="token punctuation">.</span>js<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache</span>               pnc<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_valid</span>         <span class="token number">200</span> <span class="token number">304</span> <span class="token number">7</span>d<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_valid</span>         any <span class="token number">1</span>m<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_lock</span>          on<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_lock_timeout</span>  <span class="token number">5</span>s<span class="token punctuation">;</span>
        <span class="token keyword">proxy_cache_use_stale</span>     updating error <span class="token keyword">timeout</span> invalid_header http_500 http_502<span class="token punctuation">;</span>
        etag                      on<span class="token punctuation">;</span>
        <span class="token keyword">expires</span>                   <span class="token number">7</span>d<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>由于Firekylin的路由是用来做post的，所以需要一个alias的设置，将<code>path-to-static</code>替换成你存放的目录即可。我这里设置的缓存时间是一周，你也可以根据需要改变这个时间，但是不宜过长。</p><p>这样我们得到了一个本地的analytics.js，但是它不会自动更新文件，这时候就需要定时任务了。</p><p><code>crontab -e</code>添加定时任务如下：</p><pre class="language-bash"><code>0 0 * * 0 <span class="token function">wget</span> https://www.google-analytics.com/analytics.js -O /path-to-static/analytics.js
</code></pre><p>我这里设置的是每周日0点自动去wget需要的analytics.js，替换自己目录的该文件。你也可以根据自己的缓存时间来编写自己的定时任务。</p><p>配置结束，来看下效果：</p><p><img src="https://static.excaliburhan.com/blog/20161226/t-ewsBrXtS7W0jbTdb65-BfN.jpeg?imageView2/0/w/600" alt="alt"></p><p>放下初次加载没有缓存的对比图：</p><p><img src="https://static.excaliburhan.com/blog/20161226/eNZcJtpm9cUe6WzW0h9x5bP5.jpeg?imageView2/0/w/600" alt="alt"></p><h2 id="结束"><a href="#结束" aria-hidden="true" class="header-anchor">#</a> 结束</h2><p>看我截图的加载时间，发现缓存之后，<code>index.html</code>有时候会加载比较久的时间，这是和网络相关的。但是，可以确定的是，走缓存的资源都是秒加载的，是不是很爽？</p><p>如果你也用Firekylin的博客，可以按照这个方法进行下优化，如果不是这个博客系统，一些方法也可以参考。如果你有什么意见或建议，欢迎一起探讨～</p></div><!----><!----></div></div></div>
    <script src="/blog/assets/js/4.deae28fa.js" defer></script><script src="/blog/assets/js/app.1f817541.js" defer></script>
  </body>
</html>
