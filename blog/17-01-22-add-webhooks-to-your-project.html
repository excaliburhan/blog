<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>韩小平的博客 | 给你的项目增加Webhooks，自动进行部署（包含Github/Gitlab）</title>
    <meta name="description" content="Just A Coder.">
    
    
    <link rel="preload" href="/blog/assets/css/23.styles.cc8c2f9e.css" as="style"><link rel="preload" href="/blog/assets/js/app.13a05c80.js" as="script"><link rel="preload" href="/blog/assets/js/4.388e3236.js" as="script"><link rel="prefetch" href="/blog/assets/js/12.f8a3eb3b.js"><link rel="prefetch" href="/blog/assets/js/1.93c59e2f.js"><link rel="prefetch" href="/blog/assets/js/2.a507d539.js"><link rel="prefetch" href="/blog/assets/js/3.ead3c067.js"><link rel="prefetch" href="/blog/assets/js/5.b5290f86.js"><link rel="prefetch" href="/blog/assets/js/6.7b28e046.js"><link rel="prefetch" href="/blog/assets/js/7.2119cc46.js"><link rel="prefetch" href="/blog/assets/js/8.b78f497a.js"><link rel="prefetch" href="/blog/assets/js/9.1865abc6.js"><link rel="prefetch" href="/blog/assets/js/10.8acc4974.js"><link rel="prefetch" href="/blog/assets/js/11.05c20cce.js"><link rel="prefetch" href="/blog/assets/js/0.bbd41d67.js"><link rel="prefetch" href="/blog/assets/js/13.fa869d5b.js"><link rel="prefetch" href="/blog/assets/js/14.f9caba99.js"><link rel="prefetch" href="/blog/assets/js/15.c625f060.js"><link rel="prefetch" href="/blog/assets/js/16.58675ce4.js"><link rel="prefetch" href="/blog/assets/js/17.f4199ca5.js"><link rel="prefetch" href="/blog/assets/js/18.a6b55b07.js"><link rel="prefetch" href="/blog/assets/js/19.32b86097.js"><link rel="prefetch" href="/blog/assets/js/20.f17a10f8.js"><link rel="prefetch" href="/blog/assets/js/21.c6d918ad.js"><link rel="prefetch" href="/blog/assets/js/22.3be36221.js">
    <link rel="stylesheet" href="/blog/assets/css/23.styles.cc8c2f9e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/blog/" class="home-link router-link-active"><!----><span class="site-name">
      韩小平的博客
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/blog/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/blog/links/" class="nav-link">友链</a></div><a href="https://github.com/excaliburhan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/blog/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/blog/links/" class="nav-link">友链</a></div><a href="https://github.com/excaliburhan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><!----></div><div class="page"><div class="content"><h1 id="给你的项目增加webhooks，自动进行部署（包含github-gitlab）"><a href="#给你的项目增加webhooks，自动进行部署（包含github-gitlab）" aria-hidden="true" class="header-anchor">#</a> 给你的项目增加Webhooks，自动进行部署（包含Github/Gitlab）</h1><h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2><p>Github或者Gitlab的Webhooks，允许用户订阅特定的事件，如commit, push，两者不尽相同，但本质差不太多。Github的可以参看<a href="https://developer.github.com/webhooks/" target="_blank" rel="noopener noreferrer">github webhooks</a>，Gitlab可以参看<a href="https://docs.gitlab.com/ee/web_hooks/web_hooks.html" target="_blank" rel="noopener noreferrer">gitlab webhooks</a>。</p><p>本文后续都以Github为例进行讲解，Gitlab相关可以参考相关内容。</p><h2 id="自动部署脚本"><a href="#自动部署脚本" aria-hidden="true" class="header-anchor">#</a> 自动部署脚本</h2><p>Webhooks的作用就是在特定的事件执行的时候触发自定义的动作。本质上，Github的Webhooks触发后，会给相应的URL(自行设置，后面会讲解)发送POST请求，请求头中含有event等相应的信息。</p><p>而正确响应后的事件，比如push完之后，触发自动部署脚本，现在我们来写一个简单的脚本。</p><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
PROJECT_DIR <span class="token operator">=</span> <span class="token string">'path-to-your-project'</span>

<span class="token keyword">echo</span> <span class="token string">'start'</span>
<span class="token function">cd</span> <span class="token variable">$PROJECT_DIR</span>

<span class="token keyword">echo</span> <span class="token string">'pull code'</span>
<span class="token function">git</span> reset --hard origin/master <span class="token operator">&amp;&amp;</span> <span class="token function">git</span> clean -f
<span class="token function">git</span> pull <span class="token operator">&amp;&amp;</span> <span class="token function">git</span> checkout master

<span class="token keyword">echo</span> <span class="token string">'run npm script'</span>
<span class="token function">npm</span> run build

<span class="token keyword">echo</span> <span class="token string">'finished'</span>
</code></pre><p>脚本大概的作用就是cd到项目目录，拉取最新的代码，build代码(该步骤不一定需要，如果你的代码直接可以上测试/生产环境)。你必须保证，脚本中涉及的环境变量是可用的，比如<code>git</code>，<code>npm</code>等等。</p><p>我们把这个脚本命名为<code>deploy.sh</code>，暂时放在一边，等需要的时候再用。</p><h2 id="设置webhooks"><a href="#设置webhooks" aria-hidden="true" class="header-anchor">#</a> 设置Webhooks</h2><p>在你的项目中，通过<code>Settings</code> -&gt; <code>Webhooks</code> -&gt; <code>Add webhook</code>进入webhook设置页面。我们以下都以push事件为例。</p><p><img src="https://static.excaliburhan.com/blog/20170122/Yqhvg8aNP-edKP-2WLADJWRz.jpeg?imageView2/0/w/600" alt="alt"></p><p><code>Payload URL</code>就是push之后，请求的url，我们这是<code>https://example.com/app</code>。</p><p><code>Content type</code>目前有两种，根据server提供的来写，我们选择json格式的，因为后面的server使用的是json的。</p><p><code>Secret</code>就是密码了，后面校验的时候需要用到。</p><p><code>events</code>就是触发的事件列表，我们选push就行了，可以选择全部事件(第二个选项)，也可以根据需要选择(第三个选项)。个人建议最好是根据需要去选择，不然会发送很多无谓的请求，加重服务器的压力。</p><p>然后就是处理请求的逻辑了，目前Github上有很多处理的handler。对于前端，当然是node的最熟悉，可以采用<a href="https://github.com/rvagg/github-webhook-handler" target="_blank" rel="noopener noreferrer">github-webhook-handler</a>，但是这个单个webhook处理比较方便，多个会比较麻烦，所以这里采用的就是我自己撸的一个支持多个webhooks的<a href="https://github.com/excaliburhan/node-github-webhook" target="_blank" rel="noopener noreferrer">node-github-webhook</a>。</p><h3 id="安装"><a href="#安装" aria-hidden="true" class="header-anchor">#</a> 安装</h3><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> node-github-webhook --save
</code></pre><h3 id="入口文件app-js"><a href="#入口文件app-js" aria-hidden="true" class="header-anchor">#</a> 入口文件app.js</h3><pre class="language-js"><code><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> createHandler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-github-webhook'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token function">createHandler</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/app'</span><span class="token punctuation">,</span> secret<span class="token punctuation">:</span> <span class="token string">'appsecret'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// single handler</span>

<span class="token keyword">function</span> <span class="token function">execFunc</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> exec <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exec
  <span class="token function">exec</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'exec error:'</span> <span class="token operator">+</span> error<span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stdout:'</span> <span class="token operator">+</span> stdout<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stderr:'</span> <span class="token operator">+</span> stderr<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'no such location'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">7777</span><span class="token punctuation">)</span>

handler<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error:'</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

handler<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token string">'Received a push event for %s to %s'</span><span class="token punctuation">,</span>
    event<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    event<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>ref
  <span class="token punctuation">)</span>
  <span class="token function">execFunc</span><span class="token punctuation">(</span><span class="token string">'sh ./deploy.sh'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p><code>path</code>就是前面<code>Payload URL</code>的内容，切记，是不包含host的，<code>secret</code>就是自己设置的密码。</p><p>这里为了方便，写的是单个webhook的设置，如果你有多个项目，设置请参考<a href="https://github.com/excaliburhan/node-github-webhook" target="_blank" rel="noopener noreferrer">这个</a>。</p><h2 id="守护程序"><a href="#守护程序" aria-hidden="true" class="header-anchor">#</a> 守护程序</h2><p>理论上，现在就可以运行了。</p><pre class="language-bash"><code>node app.js
</code></pre><p>但是，现在的node-github-webhook遇到错误是直接抛错的，会终止程序的进行，所以最好采用守护进程去运行，如<code>pm2</code>，<code>forever</code>，我这采用了<code>pm2</code>。</p><pre class="language-bash"><code>pm2 start app.js
</code></pre><h2 id="反向代理"><a href="#反向代理" aria-hidden="true" class="header-anchor">#</a> 反向代理</h2><p>现在程序是在7777端口跑的，需要Ngnix反向代理到80端口。这里就不展开了。如果不想做，可以直接把<code>Payload URL</code>设置成<code>https://example.com:7777/app</code>，就是看起来不够优雅。</p><h2 id="结果"><a href="#结果" aria-hidden="true" class="header-anchor">#</a> 结果</h2><p>一般来说，如果成功了的话，你的代码就已经更新了。如果你需要看具体的请求内容和返回结果，可以在<code>Webhooks</code>里的<code>Recent Deliveries</code>查看每次请求的内容。</p></div><!----><!----></div></div></div>
    <script src="/blog/assets/js/4.388e3236.js" defer></script><script src="/blog/assets/js/app.13a05c80.js" defer></script>
  </body>
</html>
