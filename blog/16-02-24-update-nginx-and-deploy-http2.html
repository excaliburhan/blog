<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>韩小平的博客 | nginx升级mainline+网站部署http/2</title>
    <meta name="description" content="Just A Coder.">
    
    
    <link rel="preload" href="/blog/assets/css/23.styles.cc8c2f9e.css" as="style"><link rel="preload" href="/blog/assets/js/app.13a05c80.js" as="script"><link rel="preload" href="/blog/assets/js/20.f17a10f8.js" as="script"><link rel="prefetch" href="/blog/assets/js/12.f8a3eb3b.js"><link rel="prefetch" href="/blog/assets/js/1.93c59e2f.js"><link rel="prefetch" href="/blog/assets/js/2.a507d539.js"><link rel="prefetch" href="/blog/assets/js/3.ead3c067.js"><link rel="prefetch" href="/blog/assets/js/4.388e3236.js"><link rel="prefetch" href="/blog/assets/js/5.b5290f86.js"><link rel="prefetch" href="/blog/assets/js/6.7b28e046.js"><link rel="prefetch" href="/blog/assets/js/7.2119cc46.js"><link rel="prefetch" href="/blog/assets/js/8.b78f497a.js"><link rel="prefetch" href="/blog/assets/js/9.1865abc6.js"><link rel="prefetch" href="/blog/assets/js/10.8acc4974.js"><link rel="prefetch" href="/blog/assets/js/11.05c20cce.js"><link rel="prefetch" href="/blog/assets/js/0.bbd41d67.js"><link rel="prefetch" href="/blog/assets/js/13.fa869d5b.js"><link rel="prefetch" href="/blog/assets/js/14.f9caba99.js"><link rel="prefetch" href="/blog/assets/js/15.c625f060.js"><link rel="prefetch" href="/blog/assets/js/16.58675ce4.js"><link rel="prefetch" href="/blog/assets/js/17.f4199ca5.js"><link rel="prefetch" href="/blog/assets/js/18.a6b55b07.js"><link rel="prefetch" href="/blog/assets/js/19.32b86097.js"><link rel="prefetch" href="/blog/assets/js/21.c6d918ad.js"><link rel="prefetch" href="/blog/assets/js/22.3be36221.js">
    <link rel="stylesheet" href="/blog/assets/css/23.styles.cc8c2f9e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/blog/" class="home-link router-link-active"><!----><span class="site-name">
      韩小平的博客
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/blog/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/blog/links/" class="nav-link">友链</a></div><a href="https://github.com/excaliburhan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/blog/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/blog/links/" class="nav-link">友链</a></div><a href="https://github.com/excaliburhan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><!----></div><div class="page"><div class="content"><h1 id="nginx升级mainline-网站部署http-2"><a href="#nginx升级mainline-网站部署http-2" aria-hidden="true" class="header-anchor">#</a> nginx升级mainline+网站部署http/2</h1><h2 id="nginx版本"><a href="#nginx版本" aria-hidden="true" class="header-anchor">#</a> nginx版本</h2><p>nginx共有3个版本。</p><p>Mainline version: 最新的开发版</p><p>Stable version: 最新的稳定版本</p><p>Legacy version: 历史遗留版本</p><p>大部分人(我之前)都是使用stable的版本的，最近看到<a href="https://imququ.com/post/nginx-http2-patch.html" target="_blank" rel="noopener noreferrer">一篇文章</a>发现nginx在1.9.5之后开始支持http/2了，于是尝试给自己网站部署http/2。</p><p>不过目前stable版本是1.8.1，只有mainline版本是1.9.5+(目前是1.9.11)，所以需要手动升级nginx为mainline版本。</p><h2 id="升级nginx到mainline版本"><a href="#升级nginx到mainline版本" aria-hidden="true" class="header-anchor">#</a> 升级nginx到mainline版本</h2><p>具体升级办法可以在nginx官网找到，<a href="http://nginx.org/en/linux_packages.html#distributions" target="_blank" rel="noopener noreferrer">攻略在此</a>。
我的服务器是CentOS6.5，根据文档按图索骥即可。</p><ul><li>创建nginx安装的yum源</li></ul><pre class="language-bash"><code>vim /etc/yum.repos.d/nginx.repo
</code></pre><ul><li>将以下内容填入nginx.repo</li></ul><pre class="language-bash"><code><span class="token punctuation">[</span>nginx<span class="token punctuation">]</span>
name<span class="token operator">=</span>nginx repo
baseurl<span class="token operator">=</span>http://nginx.org/packages/mainline/OS/OSRELEASE/<span class="token variable">$basearch</span>/
gpgcheck<span class="token operator">=</span>0
enabled<span class="token operator">=</span>1
</code></pre><p>其中OS=centos，OSRELEASE=6.5，其他系统版本根据文档自行调整。</p><ul><li>安装</li></ul><pre class="language-bash"><code>yum <span class="token function">install</span> nginx
</code></pre><h2 id="ssl证书"><a href="#ssl证书" aria-hidden="true" class="header-anchor">#</a> ssl证书</h2><p>接下来就是下载安装ssl证书了。一般的ssl证书需要用钱购买，不过最近比较火热的一款免费https证书，Lets Encrypt，使用相当简单(<s>傻瓜</s>)。</p><p>然而Lets Encrypt官方的步骤还是比较复杂的，github上有个人写了一个<a href="https://github.com/xdtianyu/scripts/tree/master/lets-encrypt" target="_blank" rel="noopener noreferrer">自动化脚本</a>，一键生成证书。</p><ul><li>wget到本地</li></ul><p>创建存放证书的目录，我创建在nginx目录下。</p><pre class="language-bash"><code><span class="token function">cd</span> /etc/nginx <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> letsencrypt
<span class="token function">wget</span> https://raw.githubusercontent.com/xdtianyu/scripts/master/lets-encrypt/letsencrypt.conf
<span class="token function">wget</span> https://raw.githubusercontent.com/xdtianyu/scripts/master/lets-encrypt/letsencrypt.sh
<span class="token function">chmod</span> +x letsencrypt.sh
</code></pre><ul><li>配置信息</li></ul><p>cd到刚才的目录下，修改conf文件</p><pre class="language-vim"><code>ACCOUNT_KEY<span class="token operator">=</span><span class="token string">&quot;letsencrypt-account.key&quot;</span>
DOMAIN_KEY<span class="token operator">=</span><span class="token string">&quot;domain.key&quot;</span>
DOMAIN_DIR<span class="token operator">=</span><span class="token string">&quot;/var/www/domain.com&quot;</span>
DOMAINS<span class="token operator">=</span><span class="token string">&quot;DNS:domain.com,DNS:www.domain.com&quot;</span>
</code></pre><p>根据你的域名信息，修改DOMAINKEY，DOMAINDIR，DOMAINS即可。注意，Lets Encrypt证书并不支持泛域名(太可惜了!)。</p><ul><li>运行</li></ul><pre class="language-bash"><code>./letsencrypt.sh letsencrypt.conf
</code></pre><p>脚本会自动生成多个文件。</p><ul><li>定时任务</li></ul><p>由于Lets Encrypt证书有效时间为90天，所以最好设定一个定时任务，比如一个月，自动更新证书。</p><pre class="language-bash"><code>0 0 1 * * /etc/nginx/certs/letsencrypt.sh /etc/nginx/certs/letsencrypt.conf <span class="token operator">&gt;&gt;</span> /var/log/lets-encrypt.log 2<span class="token operator">&gt;</span><span class="token operator">&amp;</span>1
</code></pre><p>你可以在sh文件最后加上service nginx reload，更加智能。</p><h2 id="配置nginx"><a href="#配置nginx" aria-hidden="true" class="header-anchor">#</a> 配置nginx</h2><p>然后就是配置nginx文件了。</p><pre class="language-bash"><code>vim /etc/nginx/nginx.conf
</code></pre><p>编辑https的server内容。</p><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span>               <span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>
    <span class="token keyword">server_name</span>          www<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>com domain<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

    <span class="token keyword">ssl_certificate</span>      <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>letsencrypt<span class="token operator">/</span>domain<span class="token punctuation">.</span>chained<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>
    <span class="token keyword">ssl_certificate_key</span>  <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>letsencrypt<span class="token operator">/</span>domain<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>如此配置后，通过http访问还是会访问80端口，可以做一个http跳转。</p><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span>               <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">server_name</span>          www<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>com domain<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>com<span class="token variable">$request_uri</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>最后重启下nginx。</p><pre class="language-bash"><code><span class="token function">service</span> nginx restart
</code></pre><h2 id="最终效果"><a href="#最终效果" aria-hidden="true" class="header-anchor">#</a> 最终效果</h2><p><img src="https://o2znrmehg.qnssl.com/ghost/2016/03/04/https-1457070223090.png" alt="pic"></p><p>至于https证书有什么用，当然是更加安全(<s>装逼</s>)。</p><p>至少，运行商不能劫持了～</p></div><!----><!----></div></div></div>
    <script src="/blog/assets/js/20.f17a10f8.js" defer></script><script src="/blog/assets/js/app.13a05c80.js" defer></script>
  </body>
</html>
