<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>韩小平的博客 | FireKylin博客上传图片更换为七牛CDN</title>
    <meta name="description" content="Just A Coder.">
    
    
    <link rel="preload" href="/assets/css/23.styles.40677ac6.css" as="style"><link rel="preload" href="/assets/js/app.e57f2dcc.js" as="script"><link rel="preload" href="/assets/js/9.1865abc6.js" as="script"><link rel="prefetch" href="/assets/js/12.f8a3eb3b.js"><link rel="prefetch" href="/assets/js/1.93c59e2f.js"><link rel="prefetch" href="/assets/js/2.a507d539.js"><link rel="prefetch" href="/assets/js/3.ead3c067.js"><link rel="prefetch" href="/assets/js/4.388e3236.js"><link rel="prefetch" href="/assets/js/5.b5290f86.js"><link rel="prefetch" href="/assets/js/6.7b28e046.js"><link rel="prefetch" href="/assets/js/7.2119cc46.js"><link rel="prefetch" href="/assets/js/8.b78f497a.js"><link rel="prefetch" href="/assets/js/10.8acc4974.js"><link rel="prefetch" href="/assets/js/11.05c20cce.js"><link rel="prefetch" href="/assets/js/0.bbd41d67.js"><link rel="prefetch" href="/assets/js/13.fa869d5b.js"><link rel="prefetch" href="/assets/js/14.f9caba99.js"><link rel="prefetch" href="/assets/js/15.c625f060.js"><link rel="prefetch" href="/assets/js/16.58675ce4.js"><link rel="prefetch" href="/assets/js/17.f4199ca5.js"><link rel="prefetch" href="/assets/js/18.a6b55b07.js"><link rel="prefetch" href="/assets/js/19.32b86097.js"><link rel="prefetch" href="/assets/js/20.f17a10f8.js"><link rel="prefetch" href="/assets/js/21.c6d918ad.js"><link rel="prefetch" href="/assets/js/22.3be36221.js">
    <link rel="stylesheet" href="/assets/css/23.styles.40677ac6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      韩小平的博客
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/links/" class="nav-link">友链</a></div><a href="https://github.com/excaliburhan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/links/" class="nav-link">友链</a></div><a href="https://github.com/excaliburhan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><!----></div><div class="page"><div class="content"><h1 id="firekylin博客上传图片更换为七牛cdn"><a href="#firekylin博客上传图片更换为七牛cdn" aria-hidden="true" class="header-anchor">#</a> FireKylin博客上传图片更换为七牛CDN</h1><h2 id="前情"><a href="#前情" aria-hidden="true" class="header-anchor">#</a> 前情</h2><p>前几天把博客从Ghost迁移到了FireKylin。FireKylin是一个基于ThinkJS2.0，ReactJS和ES6+的博客系统，与Ghost相比，优点还是很多的。</p><ul><li>基于ThinkJS2.0，可以使用node6.x以上的版本，使用ES6+的特性；</li><li>使用ReactJS开发，符合自己的学习路线；</li><li>对生产环境做了大量优化，加载速度很快。</li></ul><h2 id="两个问题"><a href="#两个问题" aria-hidden="true" class="header-anchor">#</a> 两个问题</h2><p>第一，目前，FireKylin只能通过WordPress文件导入文章，所以我是通过手动拷贝md文件内容迁移文章的。不得不说，这还是一个体验不足的地方，不过这只是小问题。</p><p>第二，打开管理后台准备用Markdown写文章，发现上传图片的地址格式是这样的：<code>domain.com/static/upload/xxx.png</code>。Google了一下，也没有发现有这样的改造例子。</p><p>因为FireKylin的生产环境代码都是压缩过的，所以要改动十分麻烦，只能修改源代码，然后压缩代码，替换当前的生产环境代码。不过因为自己在Ghost就有改造上传图片到CDN的经验，决定自己加一个。</p><h2 id="图片上传到七牛"><a href="#图片上传到七牛" aria-hidden="true" class="header-anchor">#</a> 图片上传到七牛</h2><p>我对七牛CDN相对熟悉一点，所以这次先用七牛试手。</p><h3 id="clone代码"><a href="#clone代码" aria-hidden="true" class="header-anchor">#</a> clone代码</h3><p>把<a href="https://github.com/75team/firekylin" target="_blank" rel="noopener noreferrer">FireKylin</a>的代码fork到自己仓库，然后clone下来。</p><h3 id="安装七牛nodejs版本的sdk"><a href="#安装七牛nodejs版本的sdk" aria-hidden="true" class="header-anchor">#</a> 安装七牛NodeJS版本的SDK</h3><p>可以通过npm安装，在项目目录运行<code>npm install --save</code>。七牛SDK的使用可以查看<a href="http://o9gnz92z5.bkt.clouddn.com/code/v6/sdk/nodejs.html" target="_blank" rel="noopener noreferrer">官方文档</a>。</p><h3 id="上传到七牛云"><a href="#上传到七牛云" aria-hidden="true" class="header-anchor">#</a> 上传到七牛云</h3><p>在<code>src/admin/controller</code>目录下新建一个<code>store</code>目录，用来存放相关的逻辑。添加<code>index.js</code>，利用SDK实现upload方法。</p><pre class="language-js"><code><span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">'moment'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> qiniu <span class="token keyword">from</span> <span class="token string">'qiniu'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">SETTINGS_PATH</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>think<span class="token punctuation">.</span><span class="token constant">RESOURCE_PATH</span><span class="token punctuation">,</span> <span class="token string">'settings.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 利用www/settings.json获取配置</span>
<span class="token keyword">const</span> settings <span class="token operator">=</span> think<span class="token punctuation">.</span><span class="token function">safeRequire</span><span class="token punctuation">(</span><span class="token constant">SETTINGS_PATH</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> settings<span class="token punctuation">.</span>store <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

qiniu<span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token constant">ACCESS_KEY</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>accessKey
qiniu<span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token constant">SECRET_KEY</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>secretKey

<span class="token keyword">function</span> <span class="token function">getSavePath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> prefix <span class="token operator">=</span> config<span class="token punctuation">.</span>prefix<span class="token punctuation">;</span>
  <span class="token keyword">const</span> dir <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> basename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>basename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> bucket <span class="token operator">=</span> config<span class="token punctuation">.</span>bucket<span class="token punctuation">;</span>
  <span class="token keyword">const</span> savePath <span class="token operator">=</span> <span class="token function">getSavePath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
  <span class="token keyword">const</span> putPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>rs<span class="token punctuation">.</span>PutPolicy</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bucket<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>savePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> putPolicy<span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  enable<span class="token punctuation">:</span> config<span class="token punctuation">.</span>enable<span class="token punctuation">,</span>
  type<span class="token punctuation">:</span> config<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
  <span class="token function">upload</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> savePath <span class="token operator">=</span> <span class="token function">getSavePath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> extra <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>io<span class="token punctuation">.</span>PutExtra</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      qiniu<span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">putFile</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> savePath<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> extra<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> ret<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> compeletePath <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>origin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ret<span class="token punctuation">.</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>compeletePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>这里讲下upload方法。由于qiniu的sdk提供的putFile是一个异步函数，为了能在FireKylin中更好地使用，这里用了闭包实现了一个Promise。这样做的好处是可以根据上传的结果轻松进行resolve/reject，这也是ThinkJS的主要特性之一。</p><h3 id="修改原来的上传逻辑"><a href="#修改原来的上传逻辑" aria-hidden="true" class="header-anchor">#</a> 修改原来的上传逻辑</h3><p>由于没有文档，这时就要在源码中寻找逻辑了。最后找到了相关文件，在``src/admin/controller/api/file.js`，一看名字就知道是处理file相关逻辑的，直接看源码。</p><pre class="language-js"><code><span class="token comment">/** 处理远程抓取 **/</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'fileUrl'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFileByUrl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'fileUrl'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/** 处理导入数据 **/</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'importor'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'wordpress'</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">importFromWP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span> 省略后续逻辑
</code></pre><p>这是<code>postAction</code>的一段代码，值得注意的是，它是一个async function，查看源码你会发现，基本所有的带回调的异步函数都会改写成async function，看来前面的upload方法写成Promise还是有先见之明(笑)。</p><p>而this.file是file表单上传方法，会上传到runtime目录。而本地上传则是验证文件成功之后，利用<code>writeFile</code>将文件move到static目录。那么，我们要做的就是在move前判断是否上传到CDN，所以在<code>let file = this.file('file');</code>之后加入如下代码。</p><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>storage<span class="token punctuation">.</span>enable <span class="token operator">&amp;&amp;</span> storage<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'qiniu'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">uploadByQiniu</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>其中，storage是通过<code>import storage from '../store'</code>引入的。接着，我们来写 uploadByQiniu方法。</p><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">uploadByQiniu</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> storage<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;FILE_UPLOAD_ERROR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>到这里，如果<code>settings.json</code>文件正确设置，并打开enable开关，就可以使用七牛的CDN上传了。</p><h3 id="修正编辑器地址"><a href="#修正编辑器地址" aria-hidden="true" class="header-anchor">#</a> 修正编辑器地址</h3><p>当我在dev环境上传图片时，发现自动填入的地址变成了这样：<code>![alt](http://localhost:8360https://o2znrmehg.qnssl.com/blog/20161122/Fr-MyF6zXtCuH9Fl_5HDDckF.jpg)</code>。原来自动填入的时候，FireKylin会自动加入location.origin，看来需要改编辑器的逻辑了。</p><p>搜寻了之后，在<code>www/static/src/common/component/editor/index.jsx</code>找到了相关逻辑。</p><pre class="language-js"><code><span class="token keyword">return</span> firekylin<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>data <span class="token operator">=</span> location<span class="token punctuation">.</span>origin <span class="token operator">+</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/\.(?:jpg|jpeg|png|bmp|gif|webp|svg|wmf|tiff|ico)$/i</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">preInputText</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`![alt](</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> text <span class="token operator">=</span> that<span class="token punctuation">.</span>state<span class="token punctuation">.</span>fileUrl <span class="token operator">?</span> <span class="token string">'链接文本'</span> <span class="token punctuation">:</span> that<span class="token punctuation">.</span>state<span class="token punctuation">.</span>file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token function">preInputText</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>text<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">](</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> text<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token operator">=&gt;</span> TipAction<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>errmsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>果然，FireKylin用域名和本地上传的文件的相对路径，拼接成完整URL，而我本地上传的路径已经是绝对路径了，所以需要加一个正则判断，返回结果为绝对路径则不添加域名。</p><p>把<code>res.data = location.origin + res.data;</code>改为</p><pre class="language-js"><code><span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex">/^http.+/</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span>data <span class="token operator">=</span> location<span class="token punctuation">.</span>origin <span class="token operator">+</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>再次测试，成功！</p><h2 id="获取生产环境代码"><a href="#获取生产环境代码" aria-hidden="true" class="header-anchor">#</a> 获取生产环境代码</h2><p>现在我们改了的是源代码，而需要的是生产环境代码，需要进行babel编译，压缩等。我在项目跟路径发现了一个build.sh的脚本，打开一看，果然是build生产环境的脚本。不过最后几行应该是奇舞团发布release使用的，注释掉。</p><pre class="language-bash"><code>sh build.sh
</code></pre><p>压缩后的代码在<code>build/firekylin</code>目录。直接覆盖github下载的生产环境代码即可。</p><h2 id="反思"><a href="#反思" aria-hidden="true" class="header-anchor">#</a> 反思</h2><p>花了一晚上码到半夜2点终于实现了功能，不过还有一些瑕疵。</p><p>现在的代码还是有一个本地上传的过程，虽然看不到，但还是消耗了资源，希望后续可以改进。</p><h2 id="后记"><a href="#后记" aria-hidden="true" class="header-anchor">#</a> 后记</h2><p>最近有点忙，等有时间改进下代码，到时候不是不可以给FireKylin提个Merge Request(笑)。</p><p>如果你有什么意见想法，也请不吝赐教。</p></div><!----><!----></div></div></div>
    <script src="/assets/js/9.1865abc6.js" defer></script><script src="/assets/js/app.e57f2dcc.js" defer></script>
  </body>
</html>
