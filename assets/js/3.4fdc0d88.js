(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{68:function(t,s,a){"use strict";a.r(s);var n=a(0),o=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[a("h1",{attrs:{id:"给你的项目增加webhooks，自动进行部署（包含github-gitlab）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#给你的项目增加webhooks，自动进行部署（包含github-gitlab）","aria-hidden":"true"}},[t._v("#")]),t._v(" 给你的项目增加Webhooks，自动进行部署（包含Github/Gitlab）")]),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[t._v("#")]),t._v(" 前言")]),a("p",[t._v("Github或者Gitlab的Webhooks，允许用户订阅特定的事件，如commit, push，两者不尽相同，但本质差不太多。Github的可以参看"),a("a",{attrs:{href:"https://developer.github.com/webhooks/",target:"_blank",rel:"noopener noreferrer"}},[t._v("github webhooks")]),t._v("，Gitlab可以参看"),a("a",{attrs:{href:"https://docs.gitlab.com/ee/web_hooks/web_hooks.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("gitlab webhooks")]),t._v("。")]),a("p",[t._v("本文后续都以Github为例进行讲解，Gitlab相关可以参考相关内容。")]),a("h2",{attrs:{id:"自动部署脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自动部署脚本","aria-hidden":"true"}},[t._v("#")]),t._v(" 自动部署脚本")]),a("p",[t._v("Webhooks的作用就是在特定的事件执行的时候触发自定义的动作。本质上，Github的Webhooks触发后，会给相应的URL(自行设置，后面会讲解)发送POST请求，请求头中含有event等相应的信息。")]),a("p",[t._v("而正确响应后的事件，比如push完之后，触发自动部署脚本，现在我们来写一个简单的脚本。")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token shebang important"}},[t._v("#!/bin/bash")]),t._v("\nPROJECT_DIR "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'path-to-your-project'")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'start'")]),t._v("\n"),a("span",{attrs:{class:"token function"}},[t._v("cd")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$PROJECT_DIR")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'pull code'")]),t._v("\n"),a("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" reset --hard origin/master "),a("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" clean -f\n"),a("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" pull "),a("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout master\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'run npm script'")]),t._v("\n"),a("span",{attrs:{class:"token function"}},[t._v("npm")]),t._v(" run build\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'finished'")]),t._v("\n")])]),a("p",[t._v("脚本大概的作用就是cd到项目目录，拉取最新的代码，build代码(该步骤不一定需要，如果你的代码直接可以上测试/生产环境)。你必须保证，脚本中涉及的环境变量是可用的，比如"),a("code",[t._v("git")]),t._v("，"),a("code",[t._v("npm")]),t._v("等等。")]),a("p",[t._v("我们把这个脚本命名为"),a("code",[t._v("deploy.sh")]),t._v("，暂时放在一边，等需要的时候再用。")]),a("h2",{attrs:{id:"设置webhooks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设置webhooks","aria-hidden":"true"}},[t._v("#")]),t._v(" 设置Webhooks")]),a("p",[t._v("在你的项目中，通过"),a("code",[t._v("Settings")]),t._v(" -> "),a("code",[t._v("Webhooks")]),t._v(" -> "),a("code",[t._v("Add webhook")]),t._v("进入webhook设置页面。我们以下都以push事件为例。")]),a("p",[a("img",{attrs:{src:"https://static.excaliburhan.com/blog/20170122/Yqhvg8aNP-edKP-2WLADJWRz.jpeg?imageView2/0/w/600",alt:"alt"}})]),a("p",[a("code",[t._v("Payload URL")]),t._v("就是push之后，请求的url，我们这是"),a("code",[t._v("https://example.com/app")]),t._v("。")]),a("p",[a("code",[t._v("Content type")]),t._v("目前有两种，根据server提供的来写，我们选择json格式的，因为后面的server使用的是json的。")]),a("p",[a("code",[t._v("Secret")]),t._v("就是密码了，后面校验的时候需要用到。")]),a("p",[a("code",[t._v("events")]),t._v("就是触发的事件列表，我们选push就行了，可以选择全部事件(第二个选项)，也可以根据需要选择(第三个选项)。个人建议最好是根据需要去选择，不然会发送很多无谓的请求，加重服务器的压力。")]),a("p",[t._v("然后就是处理请求的逻辑了，目前Github上有很多处理的handler。对于前端，当然是node的最熟悉，可以采用"),a("a",{attrs:{href:"https://github.com/rvagg/github-webhook-handler",target:"_blank",rel:"noopener noreferrer"}},[t._v("github-webhook-handler")]),t._v("，但是这个单个webhook处理比较方便，多个会比较麻烦，所以这里采用的就是我自己撸的一个支持多个webhooks的"),a("a",{attrs:{href:"https://github.com/excaliburhan/node-github-webhook",target:"_blank",rel:"noopener noreferrer"}},[t._v("node-github-webhook")]),t._v("。")]),a("h3",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装","aria-hidden":"true"}},[t._v("#")]),t._v(" 安装")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("install")]),t._v(" node-github-webhook --save\n")])]),a("h3",{attrs:{id:"入口文件app-js"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#入口文件app-js","aria-hidden":"true"}},[t._v("#")]),t._v(" 入口文件app.js")]),a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" http "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'http'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" createHandler "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'node-github-webhook'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" handler "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("createHandler")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" path"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'/app'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" secret"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'appsecret'")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("// single handler")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("execFunc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("content"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" exec "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token function"}},[t._v("require")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'child_process'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exec\n  "),a("span",{attrs:{class:"token function"}},[t._v("exec")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("content"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stdout"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stderr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      console"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("error")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'exec error:'")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" error"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    console"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("log")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'stdout:'")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" stdout"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    console"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("log")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'stderr:'")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" stderr"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nhttp"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("createServer")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token function"}},[t._v("handler")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("statusCode "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("404")]),t._v("\n    res"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("end")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'no such location'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("listen")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("7777")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nhandler"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("on")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'error'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("error")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'Error:'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("message"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nhandler"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("on")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'push'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("log")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{attrs:{class:"token string"}},[t._v("'Received a push event for %s to %s'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    event"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("repository"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    event"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("payload"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ref\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token function"}},[t._v("execFunc")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'sh ./deploy.sh'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),a("p",[a("code",[t._v("path")]),t._v("就是前面"),a("code",[t._v("Payload URL")]),t._v("的内容，切记，是不包含host的，"),a("code",[t._v("secret")]),t._v("就是自己设置的密码。")]),a("p",[t._v("这里为了方便，写的是单个webhook的设置，如果你有多个项目，设置请参考"),a("a",{attrs:{href:"https://github.com/excaliburhan/node-github-webhook",target:"_blank",rel:"noopener noreferrer"}},[t._v("这个")]),t._v("。")]),a("h2",{attrs:{id:"守护程序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#守护程序","aria-hidden":"true"}},[t._v("#")]),t._v(" 守护程序")]),a("p",[t._v("理论上，现在就可以运行了。")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("node app.js\n")])]),a("p",[t._v("但是，现在的node-github-webhook遇到错误是直接抛错的，会终止程序的进行，所以最好采用守护进程去运行，如"),a("code",[t._v("pm2")]),t._v("，"),a("code",[t._v("forever")]),t._v("，我这采用了"),a("code",[t._v("pm2")]),t._v("。")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("pm2 start app.js\n")])]),a("h2",{attrs:{id:"反向代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#反向代理","aria-hidden":"true"}},[t._v("#")]),t._v(" 反向代理")]),a("p",[t._v("现在程序是在7777端口跑的，需要Ngnix反向代理到80端口。这里就不展开了。如果不想做，可以直接把"),a("code",[t._v("Payload URL")]),t._v("设置成"),a("code",[t._v("https://example.com:7777/app")]),t._v("，就是看起来不够优雅。")]),a("h2",{attrs:{id:"结果"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#结果","aria-hidden":"true"}},[t._v("#")]),t._v(" 结果")]),a("p",[t._v("一般来说，如果成功了的话，你的代码就已经更新了。如果你需要看具体的请求内容和返回结果，可以在"),a("code",[t._v("Webhooks")]),t._v("里的"),a("code",[t._v("Recent Deliveries")]),t._v("查看每次请求的内容。")])])}],!1,null,null,null);s.default=o.exports}}]);