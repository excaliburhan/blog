(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{66:function(t,a,s){"use strict";s.r(a);var n=s(0),e=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("div",{staticClass:"content"},[s("h1",{attrs:{id:"firekylin博客优化指南"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#firekylin博客优化指南","aria-hidden":"true"}},[t._v("#")]),t._v(" Firekylin博客优化指南")]),s("h2",{attrs:{id:"firekylin博客"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#firekylin博客","aria-hidden":"true"}},[t._v("#")]),t._v(" Firekylin博客")]),s("p",[t._v("Firekylin博客是一个基于ThinkJS的博客系统，本身对博客的优化已经非常不错，很多资源都已经进行了压缩或者缓存策略。")]),s("p",[t._v("但是本着能缓存就要缓存的策略，Firekylin还是有一点优化空间的，下面就是优化的要点。")]),s("h2",{attrs:{id:"优化步骤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#优化步骤","aria-hidden":"true"}},[t._v("#")]),t._v(" 优化步骤")]),s("p",[t._v("首先打开网站首页"),s("a",{attrs:{href:"https://excaliburhan.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://excaliburhan.com")]),t._v("。右键"),s("code",[t._v("检查(或者审查元素)")]),t._v("，选择"),s("code",[t._v("Network")]),t._v("查看资源加载情况：")]),s("p",[s("img",{attrs:{src:"https://static.excaliburhan.com/blog/20161226/Qr3U3tIre1tW5yiitXRf-coX.jpeg?imageView2/0/w/600",alt:"alt"}})]),s("p",[t._v("可以看到，加载的资源主要有几种，"),s("code",[t._v("首页logo")]),t._v("，"),s("code",[t._v("iconfont字体")]),t._v("，"),s("code",[t._v("google统计代码")]),t._v("，因为我没有设置首页背景图，如果有，处理应该是和logo一致的，这里就不展开了。")]),s("p",[t._v("我们首先从"),s("code",[t._v("首页logo")]),t._v("开始。")]),s("h3",{attrs:{id:"处理logo"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#处理logo","aria-hidden":"true"}},[t._v("#")]),t._v(" 处理logo")]),s("p",[t._v("我采用的logo已经是压缩过的图片，但是还有10k左右的大小，我们的目标是图片加载一律走缓存。")]),s("p",[t._v("首先采用了使用base64编码的方式，这样图片是会被缓存的。来看一下效果：")]),s("p",[s("img",{attrs:{src:"https://static.excaliburhan.com/blog/20161226/TQ8ArbcBsxN2kl501WgI4DVq.jpeg?imageView2/0/w/600",alt:"alt"}})]),s("p",[t._v("嗯，很好，图片被缓存了。不过，等等！"),s("code",[t._v("index.html")]),t._v("从原来的6.8kb变成了17.4kb，反而加载的资源大小更大了！究其原因，就是图片从jpg转变成base64图片，大小变成12kb左右，而首页logo采用的是img标签，等于说12kb的文本加载到了"),s("code",[t._v("index.html")]),t._v("中，这显然不是我们需要的。")]),s("p",[t._v("如果改成background的形式，理论上可以解决，但是加载的大小转移到了css样式文件中，1是没有解决根本问题(base64本身带来的字节大小)，2是需要改写博客源代码，成本太高，换另外一种方案。")]),s("p",[t._v("由于之前给Firekylin提了mr，现在图片上传可以支持cdn，而我一直采用的是七牛的cdn，现在换成七牛cdn看看。")]),s("p",[s("img",{attrs:{src:"https://static.excaliburhan.com/blog/20161226/6f4ngZN4E5q6eMmH5P849w0q.jpeg?imageView2/0/w/600",alt:"alt"}})]),s("p",[t._v("可以看到图片已经被缓存了，这里图片走的是cdn的缓存机制，所以它的有效时间是由cdn设置决定的。如果你看的比较仔细，你可以发现"),s("code",[t._v("index.html")]),t._v("的大小也变小了，那是因为我之前忘记截图了，更新新版本的Firekylin导致的，看来Firekylin也一直在优化呢(笑)。而这里，我们就把它还当作是6.8kb吧。")]),s("h3",{attrs:{id:"iconfont"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#iconfont","aria-hidden":"true"}},[t._v("#")]),t._v(" iconfont")]),s("p",[t._v("Firekylin采用了iconfont来处理一些全局用到的图标，首页的菜单会用到这个文件。")]),s("p",[t._v("由于这个文件以后可能会有变化，所以Firekylin给它添加了"),s("code",[t._v("?v=")]),t._v("的版本信息。")]),s("p",[t._v("那这个文件我们要怎么缓存呢，结论是采用nginx缓存！其实类似图片如果没有cdn的服务，也是可以采用这个方案的，配置大概如下：")]),s("p",[t._v("首先在"),s("code",[t._v("http")]),t._v("里配置缓存信息")]),s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_path")]),t._v("   "),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache")]),t._v(" levels"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("1")]),s("span",{attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{attrs:{class:"token number"}},[t._v("2")]),t._v(" keys_zone"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("pnc"),s("span",{attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{attrs:{class:"token number"}},[t._v("300")]),t._v("m inactive"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("10")]),t._v("m max_size"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("5")]),t._v("g"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_temp_path")]),t._v("    "),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("proxy_temp"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_key")]),t._v("    "),s("span",{attrs:{class:"token variable"}},[t._v("$host")]),s("span",{attrs:{class:"token variable"}},[t._v("$uri")]),s("span",{attrs:{class:"token variable"}},[t._v("$is_args")]),s("span",{attrs:{class:"token variable"}},[t._v("$args")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),s("p",[t._v("然后在"),s("code",[t._v("server")]),t._v("中配置相关的内容，这里我把图片的也贴出来，但是本站实际走的是cdn配置，nginx并不会生效，如果你有需要，可以按照这个进行配置")]),s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{attrs:{class:"token operator"}},[t._v("~")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("\\"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gif"),s("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("jpg"),s("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("jpeg"),s("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("png"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{attrs:{class:"token operator"}},[t._v("*")]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache")]),t._v("               pnc"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_valid")]),t._v("         "),s("span",{attrs:{class:"token number"}},[t._v("200")]),t._v(" "),s("span",{attrs:{class:"token number"}},[t._v("304")]),t._v(" "),s("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("d"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_valid")]),t._v("         any "),s("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("m"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_lock")]),t._v("          on"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_lock_timeout")]),t._v("  "),s("span",{attrs:{class:"token number"}},[t._v("5")]),t._v("s"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_use_stale")]),t._v("     updating error "),s("span",{attrs:{class:"token keyword"}},[t._v("timeout")]),t._v("   invalid_header http_500 http_502"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        etag                      on"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("expires")]),t._v("                   "),s("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("d"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{attrs:{class:"token operator"}},[t._v("~")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v("\\"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ico"),s("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("svg"),s("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("ttf"),s("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("eot"),s("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("woff"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{attrs:{class:"token operator"}},[t._v("*")]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache")]),t._v("               pnc"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_valid")]),t._v("         "),s("span",{attrs:{class:"token number"}},[t._v("200")]),t._v(" "),s("span",{attrs:{class:"token number"}},[t._v("304")]),t._v(" "),s("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("y"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_valid")]),t._v("         any "),s("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("m"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_lock")]),t._v("          on"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_lock_timeout")]),t._v("  "),s("span",{attrs:{class:"token number"}},[t._v("5")]),t._v("s"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_use_stale")]),t._v("     updating error "),s("span",{attrs:{class:"token keyword"}},[t._v("timeout")]),t._v(" invalid_header http_500 http_502"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        etag                      on"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("expires")]),t._v("                   "),s("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("y"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),s("p",[t._v("这里需要注意的是，"),s("code",[t._v("server")]),t._v("中的"),s("code",[t._v("proxy_cache")]),t._v("的名称要和"),s("code",[t._v("http")]),t._v("中配置的"),s("code",[t._v("keys_zone")]),t._v("一致。")]),s("p",[t._v("上面的"),s("code",[t._v("server")]),t._v("配置，第一条是对常见图片结尾的文件进行一天的缓存，这里不建议把缓存时间定很长，否则你的同路径同名称的图片可能很久都不会改变。第二条就是对字体文件结尾的文件进行一年的缓存。这个可以设置久一些，因为一般这个文件是不会变动的，如果变动，版本信息导致的变动也会让etag改变，从而刷新缓存。")]),s("p",[t._v("重启nginx看下效果：")]),s("p",[s("img",{attrs:{src:"https://static.excaliburhan.com/blog/20161226/vTIfBpqGqt4PEevZNoeVXjKq.jpeg?imageView2/0/w/600",alt:"alt"}})]),s("h3",{attrs:{id:"google统计代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#google统计代码","aria-hidden":"true"}},[t._v("#")]),t._v(" google统计代码")]),s("p",[t._v("下面就是google的统计代码了。由于是异步获取的google官方的analytics.js文件，其实对于网站加载是完全没有影响的。而google设置的缓存时间是2小时，这个时间太短了，以至于google自己的官方检测给出的意见是提高该js的缓存时间- -，检测的地址是:")]),s("p",[s("a",{attrs:{href:"https://developers.google.com/speed/pagespeed/insights/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://developers.google.com/speed/pagespeed/insights/")])]),s("p",[t._v("那么对于这个js文件怎么办呢？分析一下，主要有两点，一是延长js的缓存时间，而是保证js是最新的。")]),s("p",[t._v("google官方是提供自定义请求来达到统计功能的，"),s("a",{attrs:{href:"https://imququ.com/post/summary-of-my-blog-optimization.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("屈屈的零散优化点汇总")]),t._v("这篇文章就是采用这个方法的。")]),s("p",[t._v("但是这个方法有一定的局限性，一是需要改写服务端的代码，添加统计逻辑，二是你的服务器必须能ping通google的api地址，所以说并不太实用。")]),s("p",[t._v("我这里采用了"),s("code",[t._v("nginx缓存")]),t._v("+"),s("code",[t._v("定时任务")]),t._v("将google统计代码本地化，从而达到优化的目的。")]),s("p",[t._v("首先，当然是nginx缓存配置：")]),s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),s("span",{attrs:{class:"token operator"}},[t._v("~")]),s("span",{attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("analytics\\"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("js"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$ "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("alias")]),t._v("                     "),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("path"),s("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("to"),s("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("static"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("analytics"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("js"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache")]),t._v("               pnc"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_valid")]),t._v("         "),s("span",{attrs:{class:"token number"}},[t._v("200")]),t._v(" "),s("span",{attrs:{class:"token number"}},[t._v("304")]),t._v(" "),s("span",{attrs:{class:"token number"}},[t._v("7")]),t._v("d"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_valid")]),t._v("         any "),s("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("m"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_lock")]),t._v("          on"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_lock_timeout")]),t._v("  "),s("span",{attrs:{class:"token number"}},[t._v("5")]),t._v("s"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("proxy_cache_use_stale")]),t._v("     updating error "),s("span",{attrs:{class:"token keyword"}},[t._v("timeout")]),t._v(" invalid_header http_500 http_502"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        etag                      on"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{attrs:{class:"token keyword"}},[t._v("expires")]),t._v("                   "),s("span",{attrs:{class:"token number"}},[t._v("7")]),t._v("d"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),s("p",[t._v("由于Firekylin的路由是用来做post的，所以需要一个alias的设置，将"),s("code",[t._v("path-to-static")]),t._v("替换成你存放的目录即可。我这里设置的缓存时间是一周，你也可以根据需要改变这个时间，但是不宜过长。")]),s("p",[t._v("这样我们得到了一个本地的analytics.js，但是它不会自动更新文件，这时候就需要定时任务了。")]),s("p",[s("code",[t._v("crontab -e")]),t._v("添加定时任务如下：")]),s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("0 0 * * 0 "),s("span",{attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://www.google-analytics.com/analytics.js -O /path-to-static/analytics.js\n")])]),s("p",[t._v("我这里设置的是每周日0点自动去wget需要的analytics.js，替换自己目录的该文件。你也可以根据自己的缓存时间来编写自己的定时任务。")]),s("p",[t._v("配置结束，来看下效果：")]),s("p",[s("img",{attrs:{src:"https://static.excaliburhan.com/blog/20161226/t-ewsBrXtS7W0jbTdb65-BfN.jpeg?imageView2/0/w/600",alt:"alt"}})]),s("p",[t._v("放下初次加载没有缓存的对比图：")]),s("p",[s("img",{attrs:{src:"https://static.excaliburhan.com/blog/20161226/eNZcJtpm9cUe6WzW0h9x5bP5.jpeg?imageView2/0/w/600",alt:"alt"}})]),s("h2",{attrs:{id:"结束"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#结束","aria-hidden":"true"}},[t._v("#")]),t._v(" 结束")]),s("p",[t._v("看我截图的加载时间，发现缓存之后，"),s("code",[t._v("index.html")]),t._v("有时候会加载比较久的时间，这是和网络相关的。但是，可以确定的是，走缓存的资源都是秒加载的，是不是很爽？")]),s("p",[t._v("如果你也用Firekylin的博客，可以按照这个方法进行下优化，如果不是这个博客系统，一些方法也可以参考。如果你有什么意见或建议，欢迎一起探讨～")])])}],!1,null,null,null);a.default=e.exports}}]);