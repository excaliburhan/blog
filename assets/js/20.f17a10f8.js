(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{52:function(t,s,n){"use strict";n.r(s);var a=n(0),e=Object(a.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"nginx升级mainline-网站部署http-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx升级mainline-网站部署http-2","aria-hidden":"true"}},[t._v("#")]),t._v(" nginx升级mainline+网站部署http/2")]),n("h2",{attrs:{id:"nginx版本"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx版本","aria-hidden":"true"}},[t._v("#")]),t._v(" nginx版本")]),n("p",[t._v("nginx共有3个版本。")]),n("p",[t._v("Mainline version: 最新的开发版")]),n("p",[t._v("Stable version: 最新的稳定版本")]),n("p",[t._v("Legacy version: 历史遗留版本")]),n("p",[t._v("大部分人(我之前)都是使用stable的版本的，最近看到"),n("a",{attrs:{href:"https://imququ.com/post/nginx-http2-patch.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("一篇文章")]),t._v("发现nginx在1.9.5之后开始支持http/2了，于是尝试给自己网站部署http/2。")]),n("p",[t._v("不过目前stable版本是1.8.1，只有mainline版本是1.9.5+(目前是1.9.11)，所以需要手动升级nginx为mainline版本。")]),n("h2",{attrs:{id:"升级nginx到mainline版本"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#升级nginx到mainline版本","aria-hidden":"true"}},[t._v("#")]),t._v(" 升级nginx到mainline版本")]),n("p",[t._v("具体升级办法可以在nginx官网找到，"),n("a",{attrs:{href:"http://nginx.org/en/linux_packages.html#distributions",target:"_blank",rel:"noopener noreferrer"}},[t._v("攻略在此")]),t._v("。\n我的服务器是CentOS6.5，根据文档按图索骥即可。")]),n("ul",[n("li",[t._v("创建nginx安装的yum源")])]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("vim /etc/yum.repos.d/nginx.repo\n")])]),n("ul",[n("li",[t._v("将以下内容填入nginx.repo")])]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("nginx"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nname"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx repo\nbaseurl"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("http://nginx.org/packages/mainline/OS/OSRELEASE/"),n("span",{attrs:{class:"token variable"}},[t._v("$basearch")]),t._v("/\ngpgcheck"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("0\nenabled"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("1\n")])]),n("p",[t._v("其中OS=centos，OSRELEASE=6.5，其他系统版本根据文档自行调整。")]),n("ul",[n("li",[t._v("安装")])]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("yum "),n("span",{attrs:{class:"token function"}},[t._v("install")]),t._v(" nginx\n")])]),n("h2",{attrs:{id:"ssl证书"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ssl证书","aria-hidden":"true"}},[t._v("#")]),t._v(" ssl证书")]),n("p",[t._v("接下来就是下载安装ssl证书了。一般的ssl证书需要用钱购买，不过最近比较火热的一款免费https证书，Lets Encrypt，使用相当简单("),n("s",[t._v("傻瓜")]),t._v(")。")]),n("p",[t._v("然而Lets Encrypt官方的步骤还是比较复杂的，github上有个人写了一个"),n("a",{attrs:{href:"https://github.com/xdtianyu/scripts/tree/master/lets-encrypt",target:"_blank",rel:"noopener noreferrer"}},[t._v("自动化脚本")]),t._v("，一键生成证书。")]),n("ul",[n("li",[t._v("wget到本地")])]),n("p",[t._v("创建存放证书的目录，我创建在nginx目录下。")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token function"}},[t._v("cd")]),t._v(" /etc/nginx "),n("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" letsencrypt\n"),n("span",{attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://raw.githubusercontent.com/xdtianyu/scripts/master/lets-encrypt/letsencrypt.conf\n"),n("span",{attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://raw.githubusercontent.com/xdtianyu/scripts/master/lets-encrypt/letsencrypt.sh\n"),n("span",{attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x letsencrypt.sh\n")])]),n("ul",[n("li",[t._v("配置信息")])]),n("p",[t._v("cd到刚才的目录下，修改conf文件")]),n("pre",{pre:!0,attrs:{class:"language-vim"}},[n("code",[t._v("ACCOUNT_KEY"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token string"}},[t._v('"letsencrypt-account.key"')]),t._v("\nDOMAIN_KEY"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token string"}},[t._v('"domain.key"')]),t._v("\nDOMAIN_DIR"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token string"}},[t._v('"/var/www/domain.com"')]),t._v("\nDOMAINS"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token string"}},[t._v('"DNS:domain.com,DNS:www.domain.com"')]),t._v("\n")])]),n("p",[t._v("根据你的域名信息，修改DOMAINKEY，DOMAINDIR，DOMAINS即可。注意，Lets Encrypt证书并不支持泛域名(太可惜了!)。")]),n("ul",[n("li",[t._v("运行")])]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("./letsencrypt.sh letsencrypt.conf\n")])]),n("p",[t._v("脚本会自动生成多个文件。")]),n("ul",[n("li",[t._v("定时任务")])]),n("p",[t._v("由于Lets Encrypt证书有效时间为90天，所以最好设定一个定时任务，比如一个月，自动更新证书。")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("0 0 1 * * /etc/nginx/certs/letsencrypt.sh /etc/nginx/certs/letsencrypt.conf "),n("span",{attrs:{class:"token operator"}},[t._v(">>")]),t._v(" /var/log/lets-encrypt.log 2"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token operator"}},[t._v("&")]),t._v("1\n")])]),n("p",[t._v("你可以在sh文件最后加上service nginx reload，更加智能。")]),n("h2",{attrs:{id:"配置nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置nginx","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置nginx")]),n("p",[t._v("然后就是配置nginx文件了。")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("vim /etc/nginx/nginx.conf\n")])]),n("p",[t._v("编辑https的server内容。")]),n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("listen")]),t._v("               "),n("span",{attrs:{class:"token number"}},[t._v("443")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl")]),t._v(" http2"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("          www"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domain"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com domain"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl_certificate")]),t._v("      "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("letsencrypt"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("domain"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("chained"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("crt"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("ssl_certificate_key")]),t._v("  "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("letsencrypt"),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("domain"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("p",[t._v("如此配置后，通过http访问还是会访问80端口，可以做一个http跳转。")]),n("pre",{pre:!0,attrs:{class:"language-nginx"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("listen")]),t._v("               "),n("span",{attrs:{class:"token number"}},[t._v("80")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("          www"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domain"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com domain"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("301")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("https")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domain"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com"),n("span",{attrs:{class:"token variable"}},[t._v("$request_uri")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("p",[t._v("最后重启下nginx。")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token function"}},[t._v("service")]),t._v(" nginx restart\n")])]),n("h2",{attrs:{id:"最终效果"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#最终效果","aria-hidden":"true"}},[t._v("#")]),t._v(" 最终效果")]),n("p",[n("img",{attrs:{src:"https://o2znrmehg.qnssl.com/ghost/2016/03/04/https-1457070223090.png",alt:"pic"}})]),n("p",[t._v("至于https证书有什么用，当然是更加安全("),n("s",[t._v("装逼")]),t._v(")。")]),n("p",[t._v("至少，运行商不能劫持了～")])])}],!1,null,null,null);s.default=e.exports}}]);